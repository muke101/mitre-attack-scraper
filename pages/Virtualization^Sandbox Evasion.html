<ac:layout>
<ac:layout-section ac:type="two_right_sidebar">
<ac:layout-cell>
<div class="wiki-content" id="main-content">
<div class="contentLayout2">
<div class="columnLayout two-right-sidebar" data-layout="two-right-sidebar">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p>Adversaries may check for the presence of a virtual machine environment (VME) or sandbox to avoid potential detection of tools and activities. If the adversary detects a VME, they may alter their malware to conceal the core functions of the implant or disengage from the victim. They may also search for VME artifacts before dropping secondary or additional payloads.  Adversaries may use several methods including Security Software Discovery to accomplish Virtualization/Sandbox Evasion by searching for security monitoring tools (e.g., Sysinternals, Wireshark, etc.) to help determine if it is an analysis environment. Additional methods include use of sleep timers or loops within malware code to avoid operating within a temporary sandboxes.  </p><h3>Virtual Hardware Fingerprinting Discovery</h3><p>Adversaries may check the fan and temperature of the system to gather evidence that can be indicative a virtual environment. An adversary may perform a CPU check using a WMI query $q = "Select * from Win32_Fan" Get-WmiObject -Query $q. If the results of the WMI query return more than zero elements, this might tell them that the machine is a physical one.  </p><h3>User Activity Discovery</h3><p>Adversaries may search for user activity on the host (e.g., browser history, cache, bookmarks, number of files in the home directories, etc.) for reassurance of an authentic environment. They might detect this type of information via user interaction and digital signatures. They may have malware check the speed and frequency of mouse clicks to determine if it’s a sandboxed environment. Other methods may rely on specific user interaction with the system before the malicious code is activated. Examples include waiting for a document to close before activating a macro  and waiting for a user to double click on an embedded image to activate . </p><h3>Virtual Machine Environment Artifacts Discovery</h3><p>Adversaries may use utilities such as Windows Management Instrumentation, PowerShell, Systeminfo, and the Query Registry to obtain system information and search for VME artifacts. Adversaries may search for VME artifacts in memory, processes, file system, and/or the Registry. Adversaries may use Scripting to combine these checks into one script and then have the program exit if it determines the system to be a virtual environment. Also, in applications like VMWare, adversaries can use a special I/O port to send commands and receive output. Adversaries may also check the drive size. For example, this can be done using the Win32 DeviceIOControl function.  Example VME Artifacts in the Registry HKLM\SOFTWARE\Oracle\VirtualBox Guest AdditionsHKLM\HARDWARE\Description\System\"SystemBiosVersion";"VMWARE"HKLM\HARDWARE\ACPI\DSDT\BOX_ Example VME files and DLLs on the system WINDOWS\system32\drivers\vmmouse.sys WINDOWS\system32\vboxhook.dllWindows\system32\vboxdisp.dll Common checks may enumerate services running that are unique to these applications, installed programs on the system, manufacturer/product fields for strings relating to virtual machine applications, and VME-specific hardware/processor instructions. </p><h2 id="MitreRecommendations"><strong>Mitre Recommendations</strong></h2><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/></colgroup><tbody><tr><td class="confluenceTd">Mitigation</td><td class="confluenceTd"><p>Mitigation of this technique with preventative controls may impact the adversary's decision process depending on what they're looking for, how they use the information, and what their objectives are. Since it may be difficult to mitigate all aspects of information that could be gathered, efforts should be focused on preventing adversary tools from running earlier in the chain of activity and on identifying subsequent malicious behavior if compromised.</p></td></tr><tr><td class="confluenceTd"><p>Detection</p></td><td class="confluenceTd"><p style="text-align: left;">Virtualization, sandbox, and related discovery techniques will likely occur in the first steps of an operation but may also occur throughout as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as lateral movement, based on the information obtained. Detecting actions related to virtualization and sandbox identification may be difficult depending on the adversary's implementation and monitoring required. Monitoring for suspicious processes being spawned that gather a variety of system information or perform other forms of Discovery, especially in a short period of time, may aid in detection.</p></td></tr></tbody></table></div></div>
</div>
</div></div></div></ac:layout-cell>
<ac:layout-cell>
<div class="cell aside" data-type="aside">
<div class="innerCell">
<h1 id="SCORE:#/5" style="text-align: left;"><strong>SCORE: #/5</strong></h1><p><strong>ID</strong>: <a href="https://attack.mitre.org/techniques/T1497">T1497</a></p><p><strong>Tactic</strong>: Defense Evasion, Discovery</p><p><strong>Platform</strong>: Windows</p><p><strong>Data Sources</strong>: Process monitoring, Process command-line parameters</p><p><strong>Defense Bypassed</strong>: Anti-virus, Host forensic analysis, Signature-based detection, Static File Analysis</p><p><br/><p><br/></p></p></div>
</div>
</ac:layout-cell></ac:layout-section>


<ac:layout-section ac:type="single">
<ac:layout-cell>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h1 id="VISA" style="text-align: center;"><em style="letter-spacing: -0.01em;"><strong>VISA</strong></em></h1><hr/><p><br/></p></div>
</div>
</div>
</ac:layout-cell>
</ac:layout-section>
<ac:layout-section ac:type="two_equal">
<ac:layout-cell>
<div class="columnLayout two-equal" data-layout="two-equal">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h2 id="Mitigation"><strong>Mitigation </strong></h2><p></p><p><br/></p></div>
</div>
</div></ac:layout-cell>
<ac:layout-cell>
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h2 id="Detection"><strong>Detection</strong></h2><p></p></div></div></ac:layout-cell></ac:layout-section>



<ac:layout-section ac:type="single">
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p><br/></p><p>
<p></p></p></div>
</div>
</div>
</ac:layout-section>




</ac:layout>
